<?xml version="1.0" encoding="UTF-8"?>
<sequence name="sequence-in" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <property name="CODE_LOC" scope="default" type="STRING" value="sequence-in step 00"/>
    <call-template description="make log call" target="common-ct-logging-template">
        <with-param name="MESSAGE_PARAM" value="ENTER sequence-in"/>
    </call-template>
    <!-- Log trace event -->
    <property name="APIVersion" scope="default" type="STRING" value="1.0.0"/>
    <call-template target="logging-template">
        <with-param name="tracePoint" value="CT_API_SR"/>
        <with-param name="subComponent" value="sequence-in"/>
        <with-param name="logLevel" value="info"/>
    </call-template>
    <!-- 01 Loading Config -->
    <property description="CODE_LOC 01" name="CODE_LOC" scope="default" type="STRING" value="sequence-in step 01"/>
    <sequence key="sequence-load-config"/>
    <call-template target="logging-template">
        <with-param name="tracePoint" value="CT_API_CS"/>
        <with-param name="subComponent" value="sequence-in"/>
        <with-param name="logLevel" value="info"/>
    </call-template>
    <!-- 02 Call Micro service for validation and transformation -->
    <property description="CODE_LOC 02" name="CODE_LOC" scope="default" type="STRING" value="sequence-in step 02"/>
    <call-template target="microservice-assets-template">
        <with-param name="MICROSERVICE-NAME" value="microservice-json2soap"/>
        <with-param name="INPUT-SYSTEM-NAME" value="{get-property('INPUT_SYSTEM_NAME')}"/>
        <with-param name="INPUT-SERVICE-NAME" value="{get-property('INPUT_SERVICE_NAME')}"/>
        <with-param name="INPUT-SERVICE-VERSION" value="{get-property('INPUT_SERVICE_VERSION')}"/>
        <with-param name="OUTPUT-SYSTEM-NAME" value="{get-property('ETMP_OUTPUT_SYSTEM_NAME')}"/>
        <with-param name="OUTPUT-SERVICE-NAME" value="{get-property('ETMP_OUTPUT_SERVICE_NAME')}"/>
        <with-param name="OUTPUT-SERVICE-VERSION" value="{get-property('ETMP_OUTPUT_SERVICE_VERSION')}"/>
        <with-param name="FLOW-DIRECTION" value="request"/>
        <with-param name="SOURCE" value="service"/>
        <with-param name="HTTP-ACCEPT" value="application/xml"/>
        <with-param name="CONTENT-ENCODING" value="deflate"/>
    </call-template>
    <call-template target="logging-template">
        <with-param name="tracePoint" value="CT_API_CR"/>
        <with-param name="subComponent" value="sequence-in"/>
        <with-param name="logLevel" value="info"/>
    </call-template>
    <!-- 03 handle any micro-service validation error -->
    <property expression="//*[local-name()='errorDetail']/*[local-name()='errorCode']" name="MS_ERROR_CODE" scope="default" type="STRING"/>
    <filter regex="400|500" source="$ctx:MS_ERROR_CODE" xmlns:ns="http://org.apache.synapse/xsd">
        <then>
            <property description="CODE_LOC 03" name="CODE_LOC" scope="default" type="STRING" value="sequence-in step 03"/>
            <call-template target="logging-template">
                <with-param name="MESSAGE_PARAM" value="Handling error message from Asset Microservice"/>
            </call-template>
            <property name="ERROR_SOURCE" scope="default" type="STRING" value="ct-api"/>
            <property name="ERROR_CODE" scope="default" type="STRING" value="400"/>
            <property expression="//*[local-name()='errorDetail']/*[local-name()='errorMessage']" name="ERROR_MESSAGE" scope="default" type="STRING"/>
            <property expression="//*[local-name()='errorDetail']/*[local-name()='sourceFaultDetail']/*[local-name()='detail']" name="ERROR_DETAIL" scope="default" type="STRING"/>
            <property expression="$ctx:ERROR_CODE" name="HTTP_SC" scope="axis2" type="STRING"/>
            <sequence key="sequence-error"/>
        </then>
        <else/>
    </filter>
    <property expression="fn:concat('Basic ', base64Encode(fn:concat($ctx:ETMP_EP_USERNAME,':',$ctx:ETMP_EP_PASSWORD)))" name="Authorization" scope="transport" type="STRING"/>
    <property description="CODE_LOC 03" name="CODE_LOC" scope="default" type="STRING" value="sequence-in step 04"/>
    <call-template target="logging-template">
        <with-param name="MESSAGE_PARAM" value="{fn:concat('Calling ETMP backend with URL : ',$ctx:uri.var.s129.ct.backend.address)}"/>
    </call-template>
    <call-template target="logging-template">
        <with-param name="tracePoint" value="CT_API_CS"/>
        <with-param name="subComponent" value="sequence-in"/>
        <with-param name="logLevel" value="info"/>
    </call-template>
    <property description="CODE_LOC 99" name="CODE_LOC" scope="default" type="STRING" value="sequence-in step 99"/>
    <call-template description="make log call" target="logging-template">
        <with-param name="MESSAGE_PARAM" value="LEAVE sequence-in "/>
    </call-template>
    <property expression="$ctx:ETMP_EP_HEADER_MESSAGE_TYPE" name="messageType" scope="axis2" type="STRING"/>
    <property expression="$ctx:ETMP_EP_HEADER_CONTENT_TYPE" name="ContentType" scope="axis2" type="STRING"/>
    <property expression="$ctx:ETMP_EP_HEADER_SOAP_ACTION" name="SOAPAction" scope="transport" type="STRING"/>
    <header expression="$ctx:ETMP_EP_HEADER_ACCEPT" name="Accept" scope="transport"/>
   <send>
        <endpoint name="s129-ct-Endpoint" template="endpoint-template" uri="{uri.var.backend.address}"/>
    </send>
</sequence>
